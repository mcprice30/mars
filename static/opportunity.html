<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml>"
<head>
<title>Curiosity Rover Track</title>
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<meta http-equiv="imagetoolbar" content="no"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="http://curiosityrover.com/ol.css" type="text/css" >
<link rel="stylesheet" href="http://curiosityrover.com/map.css" type="text/css" >

<style type="text/css">
  html, body { overflow: hidden; padding: 0; height: 100%; width: 100%; font-family: 'Lucida Grande',Geneva,Arial,Verdana,sans-serif; }
  body { margin: 10px; background: #fff; }
  h1 { margin: 0; padding: 6px; border:0; font-size: 12pt; }
  #header { height: 90px; padding: 0; background-color: #eee; border: 1px solid #888; }
  #subheader { height: 12px; text-align: right; font-size: 10px; color: #555;}
  #map { position: absolute; height: 90%; width: 99%; }
  .olImageLoadError {  display: none !important; }
  .olControlAttribution { bottom: 0px !important; left: 2px; right: inherit; width: 400px; }
  /* conditionally position control differently for Google Maps */
  .olForeignContainer div.olControlMousePosition { bottom: 28px; }
</style>

<script src="http://curiosityrover.com/OpenLayers/OpenLayers-2.13.1/OpenLayers.js" type="text/javascript"></script>
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js'></script>

<script type="text/javascript">
	var map, layer;
	var locations;
	var markers = new OpenLayers.Layer.Markers( "Markers" );
	var roverMarker;
	var mslsize = new OpenLayers.Size(32,32);
	var msloffset = new OpenLayers.Pixel(-(mslsize.w/2), -mslsize.h + 5);
	var mslicon = new OpenLayers.Icon('http://curiosityrover.com/mslicon.png', mslsize, msloffset);

	// Map Bounds
	var mapBounds_full = new OpenLayers.Bounds(-180.000000, -90.0, 180.0, 90.0);

	var mapMinZoom = 8;
	var mapMaxZoom = 8;
	var defaultzoom = 18 ;
	var urlzoom ;
	var minZoom = 1;
	var maxZoom = 9;
	var urlcenterlon ;
	var urlcenterlat ;


	var mvnzoom = 8 ;
	function init() {
		var options = {
			controls: [
				new OpenLayers.Control.Navigation(),
				new OpenLayers.Control.KeyboardDefaults()
			],
			projection: "EPSG:900913",
			displayProjection: "EPSG:4326",
			units: "m",
			fractionalZoom: false,
			numZoomLevels: 19,
			maxResolution: 156543.0339,
		};

		this.urlzoom = $.urlParam('zoom') ;
		this.urlcenterlat = $.urlParam('lat') ;
		this.urlcenterlon = $.urlParam('lon') ;

		map = new OpenLayers.Map('map', options);

		var nasaMapOverlay = new OpenLayers.Layer.TMS("NASA explore map",
			"http://ec2-54-241-20-2.us-west-1.compute.amazonaws.com/catalog/Mars_Viking_MDIM21_ClrMosaic_global_232m/1.0.0/default/default028mm/", {
				type: 'png',
				getURL: overlay_getNASATileURL,
				alpha: false,
				isBaseLayer: false,
				tileOrigin: new OpenLayers.LonLat(0, -90)
			});

		var osm = new OpenLayers.Layer.OSM();
		var baseLayer = new OpenLayers.Layer("Blank",{isBaseLayer: true});

		var size = new OpenLayers.Size(24,30);
		var offset = new OpenLayers.Pixel(-(size.w)-1, -size.h/2);

		roverMarker = new OpenLayers.Marker(new OpenLayers.LonLat(-5.521404, -1.945188).transform(map.displayProjection, map.projection),mslicon);
		markers.addMarker(roverMarker);

		map.addLayers([
				baseLayer,nasaMapOverlay,markers
		]); 

		drawPath([
			{"latitude": -1.945188, "longitude": -5.521404},	
			{"latitude": -1.945188, "longitude": -5.501404},	
			{"latitude": -1.945188, "longitude": -5.471404},	
			{"latitude": -1.945188, "longitude": -5.441404},	
			{"latitude": -1.945188, "longitude": -5.421404},	
			{"latitude": -1.945188, "longitude": -5.401404},	
			{"latitude": -1.945188, "longitude": -5.381404},	
			{"latitude": -2.31267193421, "longitude": -5.34801458957},	
		]);

		map.isValidZoomLevel = function(zoomLevel) {
			return ((zoomLevel != null) && (zoomLevel >= minZoom) && (zoomLevel <= maxZoom));
		}

		OpenLayers.Util.onImageLoadError = function () {
				this.src = "notile.png";
		}

		var lonlat = new OpenLayers.LonLat(-5.521404, -1.945188).transform(map.displayProjection, map.projection);

		var projWGS84 = new OpenLayers.Projection("EPSG:4326");
		var proj900913 = new OpenLayers.Projection("EPSG:900913");

		if (urlzoom != null)
			map.setCenter(lonlat,urlzoom) ;
		else
			map.setCenter(lonlat,9) ;
	}

	function moveMarker(sol) {
		if (sol < 0 || sol >= locations.length) {
			console.log("Sol out of bounds!");
		} else {
			markers.removeMarker(roverMarker);
			var lon = locations[sol].longitude;
			var lat = locations[sol].latitude;
			roverMarker = new OpenLayers.Marker(new OpenLayers.LonLat(lon,
				lat).transform(map.displayProjection, map.projection), mslicon);
			markers.addMarker(roverMarker);
			markers.redraw();
		}	
	}

	function drawPath(input_locations) {
		locations = input_locations;
		var styleMap = new OpenLayers.StyleMap(OpenLayers.Util.applyDefaults({
			fill: true,
			fillColor: "black",
			fillOpacity: 1.0,
			strokeDashstyle: "solid",
			strokeOpacity: 0.6,
			strokeColor: "#3333ff",
			strokeWidth: 3
		}, OpenLayers.Feature.Vector.style["default"]));

		var vector = new OpenLayers.Layer.Vector("Track", {styleMap: styleMap});

		p = new Array();
		for (var i = 0; i < locations.length ; i++) {
			var xyLoc = new OpenLayers.LonLat(locations[i].longitude,
				locations[i].latitude).transform(map.displayProjection, map.projection)
			p[i] = new OpenLayers.Geometry.Point(xyLoc.lon, xyLoc.lat);
		}

		vector.addFeatures([new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(p))]);
		vector.display(false);

		map.addLayers([vector]);
	}

	function overlay_getNASATileURL(bounds) {
		var res = this.map.getResolution();
   	var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
   	var z = this.map.getZoom();
		var y = Math.round(bounds.bottom / (res * this.tileSize.h));
		var max = [0, 0, 1, 3, 7, 15, 31, 63, 127, 255, 511];
		y = max[z] - y;
		
		if (z <= 9 && z >= 1 && y >= 0 && x >= 0) {
			return this.url + z + "/" + y + "/" + x + "." + this.type;
		} else {
    	return "http://www.maptiler.org/img/none.png";
		}
	}

	function getWindowHeight() {
 		if (self.innerHeight) return self.innerHeight;
    if (document.documentElement && document.documentElement.clientHeight)
    	return document.documentElement.clientHeight;
    if (document.body) return document.body.clientHeight;
    return 0;
  }

 	function getWindowWidth() {
 		if (self.innerWidth) return self.innerWidth;
   	if (document.documentElement && document.documentElement.clientWidth)
   		return document.documentElement.clientWidth;
    if (document.body) return document.body.clientWidth;
   		return 0;
	}

	function resize() {
 		var map = document.getElementById("map");
   	var header = document.getElementById("header");
   	var subheader = document.getElementById("subheader");
   	map.style.height = (getWindowHeight()-127) + "px";
   	map.style.width = (getWindowWidth()-20) + "px";
   	if (map.updateSize) { map.updateSize(); };
  }

 	onresize=function(){ resize(); };

</script>
</head>
	<body onload="init();">
		<script  type="text/javascript">
			$(document).ready(function() {
				$.urlParam = function(name) {
					var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
					if (results==null){
						return null;
					} else {
						return results[1] || 0;
					}
				}
			});
		</script>
    <div id="map"></div>
  </body>
</html>
